# SETUP AND DEPLOYMENT GUIDE

## 1. Local Setup
# Install dependencies
pip install -r requirements.txt

# Run locally (Requires Google Application Credentials for surfn-peru project)
python app.py

## 2. Infrastructure Setup (One-time)
# Create Firestore database (done)
# gcloud firestore databases create --project=surfn-peru --location=us-central1 --type=firestore-native --database=expenses

## 3. Deploy to Cloud Run

### Option A: All-in-one command (Builds, Pushes, and Deploys)
# This is the easiest way. It uses Cloud Build and Container Registry automatically.
gcloud run deploy expenses-app \
    --source . \
    --project=surfn-peru \
    --region=us-central1 \
    --allow-unauthenticated \
    --service-account=expenses-runner@surfn-peru.iam.gserviceaccount.com

### Option B: Manual Build, Push, and Deploy
# 1. Build and push the image to Artifact Registry/Container Registry
gcloud builds submit --tag gcr.io/surfn-peru/expenses-app --project=surfn-peru

### Option C: Automated Build Trigger (CD)
# Automatically builds and deploys when you push a tag like 'v1.0.99' to GitHub.
# 1. Ensure your GitHub repo is connected to the project in Cloud Build console.
# 2. Run this command to create the trigger:

gcloud beta builds triggers create github \
    --name="deploy-on-tag-99" \
    --repo-owner="bwallerperu" \
    --repo-name="expenses" \
    --tag-pattern=".*\.99$" \
    --build-config="cloudbuild.yaml" \
    --project=surfn-peru

# Note: The trigger will use the new 'cloudbuild.yaml' file to handle the build and deployment.

## 4. CD Prerequisites (Authorization & Permissions)

### A. Connect GitHub to GCP (One-time)
# 1. Go to: https://console.cloud.google.com/cloud-build/triggers
# 2. Click "Manage Repositories" -> "Connect Repository".
# 3. Select "GitHub (Cloud Build GitHub App)" and authorize the 'bwallerperu/expenses' repo.

### B. Grant Cloud Build Permissions (Cloud Shell/Terminal)
# The Cloud Build service account needs permission to deploy to Cloud Run.
# Run these commands REPLACE with your project number if needed, but this shortcut works:

PROJECT_NUMBER=$(gcloud projects describe surfn-peru --format='get(projectNumber)')
CB_SA="${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com"

# Grant Cloud Run Admin
gcloud projects add-iam-policy-binding surfn-peru --member="serviceAccount:${CB_SA}" --role="roles/run.admin"

# Grant Service Account User
gcloud projects add-iam-policy-binding surfn-peru --member="serviceAccount:${CB_SA}" --role="roles/iam.serviceAccountUser"

## 5. Firestore Composite Indexes
# Run these to enable advanced filtering and sorting (takes a few minutes to build)

# Index for: User + Date Sort
gcloud firestore indexes composite create --project=surfn-peru --database=expenses --collection-group=expenses --field-config=field-path=ejecutivo,order=ascending --field-config=field-path=fecha,order=descending

# Index for: User + Category + Date Sort
gcloud firestore indexes composite create --project=surfn-peru --database=expenses --collection-group=expenses --field-config=field-path=ejecutivo,order=ascending --field-config=field-path=categoria,order=ascending --field-config=field-path=fecha,order=descending

# Index for: User + Client + Date Sort
gcloud firestore indexes composite create --project=surfn-peru --database=expenses --collection-group=expenses --field-config=field-path=ejecutivo,order=ascending --field-config=field-path=cliente,order=ascending --field-config=field-path=fecha,order=descending

# Index for: Category + Date Sort (Admin View)
gcloud firestore indexes composite create --project=surfn-peru --database=expenses --collection-group=expenses --field-config=field-path=categoria,order=ascending --field-config=field-path=fecha,order=descending

# Index for: Client + Date Sort (Admin View)
gcloud firestore indexes composite create --project=surfn-peru --database=expenses --collection-group=expenses --field-config=field-path=cliente,order=ascending --field-config=field-path=fecha,order=descending
